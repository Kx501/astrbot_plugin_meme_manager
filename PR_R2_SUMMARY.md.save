x# 添加 Cloudflare R2 图床支持

## 概述
本次PR为 AstrBot 表情包管理器添加 Cloudflare R2 图床支持，替代或补充现有的 Stardots 图床方案。R2 提供每月10GB免费存储、100万次免费操作，以及全球CDN加速，是国际用户的理想选择。

## 功能特性

### ✅ 核心功能
- **上传表情包到 Cloudflare R2**：支持自动分类，保持目录结构
- **从 R2 下载表情包**：同步云端表情包到本地
- **上传记录机制**：避免重复上传相同文件，节省流量
- **智能同步**：跳过已上传/已存在的文件，提高同步效率
- **详细日志**：便于问题排查和故障诊断

### 🌟 优势
- **免费额度充足**：每月10GB存储 + 100万次A类操作
- **全球CDN加速**：通过 Cloudflare 网络快速访问
- **支持自定义域名**：可绑定自己的域名
- **安全可靠**：S3兼容API，支持私有存储桶
- **与 Stardots 兼容**：用户可以自由选择图床服务

## 配置方法

### 1. 创建 Cloudflare R2 存储桶
1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 进入 R2 页面
3. 点击 "Create bucket" 创建存储桶
4. 记录存储桶名称（填入 `bucket_name`）

### 2. 获取 R2 API 凭证
1. 在 R2 页面，点击 "Manage R2 API Tokens"
2. 点击 "Create API Token"
3. 记录生成的 `Access Key ID` 和 `Secret Access Key`
4. 在 R2 页面右上角可以找到 `Account ID`

### 3. 插件配置
在 AstrBot 插件设置中选择 `cloudflare_r2` 并填写：

```yaml
# Cloudflare Account ID (account_id)
account_id: "your_account_id"
# R2 Access Key ID (access_key_id)
access_key_id: "your_access_key_id"
# R2 Secret Access Key (secret_access_key)
secret_access_key: "your_secret_access_key"
# R2 Bucket 名称 (bucket_name)
bucket_name: "your_bucket_name"
# 自定义CDN域名 (可选) (public_url)
# 例如: https://你的域名.com
public_url: "https://你的域名.com"
```

### 4. 开启公共访问（可选）
- 在存储桶设置中，可以绑定自定义域名
- 或者使用默认的 R2.dev 域名
- 将域名填入 `public_url` 配置项

## 使用指令

```
/表情管理 同步到云端    # 上传本地表情包到R2
/表情管理 从云端同步    # 从R2下载表情包到本地
/表情管理 同步状态      # 查看同步状态
```

## 文件管理

### 目录结构
所有文件上传到 `memes/` 文件夹，保持分类结构：

```
memes/
├── angry/
│   ├── xxx.jpg
│   └── yyy.gif
├── happy/
│   ├── zzz.png
│   └── ...
└── ...
```

### 公共URL格式
- 使用自定义域名：`https://你的域名.com/memes/{category}/{filename}`
- 使用 R2.dev 域名：`https://{bucket}.{account_id}.r2.dev/memes/{category}/{filename}`

## 版本迭代

### v3.15 - 初始支持
- ✅ 新增 Cloudflare R2 图床支持
- ✅ 基础上传/下载功能

### v3.16 - 功能完善
- ✅ 完善 R2 图床基础功能
- ✅ 修复初始bug

### v3.17 - 性能优化
- ✅ **新增上传记录机制**：避免重复上传相同文件
- ✅ **优化同步逻辑**：上传时跳过已上传文件，下载时跳过已存在文件
- ✅ 增强日志输出，便于故障排查
- ✅ 添加 R2 连接测试和存储桶访问验证
- ✅ 保持本地目录结构，分类作为子目录上传

### v3.18 - Bug修复与文件管理优化
- ✅ **修复 `AttributeError: 'MemeSender' object has no attribute 'logger'`**
  - 问题：插件启动时崩溃
  - 解决方案：延迟日志记录
  
- ✅ **修复同步进程配置传递错误**
  - 问题：`KeyError: 'key'`
  - 解决方案：添加配置格式自动检测
  
- ✅ **所有文件上传到 `memes/` 文件夹**
  - 避免污染存储桶根目录
  - 文件管理更加清晰
  
- ✅ **只检查和同步 `memes/` 文件夹**
  - 避免误删存储桶中的其他文件
  - 提高同步速度
  
- ✅ **改进 S3 键名解析**
  - 正确解析 `memes/` 前缀
  
- ✅ **简化 R2 配置 YAML**
  - README.md 只保留核心配置项

## 技术实现

### 核心文件
- `image_host/providers/cloudflare_r2_provider.py` - R2 提供商实现
- `image_host/img_sync.py` - 同步客户端
- `image_host/core/upload_tracker.py` - 上传记录器
- `image_host/core/sync_manager.py` - 同步管理器

### 依赖库
- `boto3` - AWS S3 SDK（兼容 R2 API）
- `botocore` - AWS 核心库

## 测试情况 ✅

### 功能测试
- ✅ 插件正常加载
- ✅ Cloudflare R2 初始化成功
- ✅ 同步到云端功能正常
- ✅ 从云端同步功能正常
- ✅ 文件正确上传到 `memes/` 文件夹
- ✅ 只同步 `memes/` 文件夹内的文件
- ✅ 上传记录机制工作正常
- ✅ 详细的日志记录

### 性能测试
- ✅ 跳过已上传文件，节省带宽
- ✅ 跳过已存在文件，提高同步速度
- ✅ 支持大文件上传（测试文件最大 5MB）

## 注意事项 ⚠️

### 首次使用
1. 确保 R2 存储桶已创建
2. 确保 API 凭证正确配置
3. 建议先测试小规模同步

### 升级说明
如果从旧版本升级：
- 之前上传到根目录的文件不会被自动管理
- 建议备份数据后重新同步到 `memes/` 文件夹

### 费用说明
Cloudflare R2 免费额度：
- 每月 10GB 存储
- 每月 100 万次 A 类操作
- 每月 1000 万次 B 类操作
- 超出部分按量计费

## 与 Stardots 对比

| 特性 | Cloudflare R2 | Stardots |
|------|--------------|----------|
| 免费存储 | 10GB/月 | 1GB/月 |
| 免费操作 | 100万次/月 | 未明确 |
| CDN | 全球 | 国内 |
| 自定义域名 | ✅ | ❌ |
| 适用场景 | 国际用户 | 国内用户 |

## 相关链接

- [Cloudflare R2 文档](https://developers.cloudflare.com/r2/)
- [R2 定价](https://developers.cloudflare.com/r2/pricing/)
- [R2 API 文档](https://developers.cloudflare.com/r2/api/)

## 提交记录

所有 R2 相关提交（从 v3.15 到 v3.18）：

- a0acf27: v3.18 - 所有文件上传到 R2 的 memes 文件夹，只检查和同步该文件夹
- d22abba: v3.18 - 修复 logger 初始化和同步配置传递错误
- 30f74f1: v3.18 - 简化 R2 配置 YAML
- e6dbd25: v3.18 - 更新 README.md，优化域名示例
- 99a4ffe: v3.17 - 优化 R2 图床功能，新增上传记录机制
- 6a1d8aa: v3.16 - 添加 Cloudflare R2 图床支持
- 61c4001: v3.15 - 新增 Cloudflare R2 图床支持

## 贡献者
- @piexian - 主要实现和优化
