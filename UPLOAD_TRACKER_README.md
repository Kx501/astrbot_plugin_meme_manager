# 上传记录功能说明

## 功能简介

插件现在支持**上传记录功能**，避免重复上传相同的图片到R2存储桶。

## 工作原理

### 上传逻辑（同步到云端）
1. 扫描本地所有图片文件
2. 检查每个文件是否有上传记录
3. **只上传没有记录的文件**
4. 上传成功后，记录该文件的信息
5. 下次上传时自动跳过已记录的文件

### 下载逻辑（从云端同步）
1. 获取云端所有图片列表
2. 检查每个文件本地是否存在
3. **只下载本地不存在的文件**
4. 跳过已存在的文件

## 上传记录文件

- **位置**：`memes_data/memes/.upload_tracker.json`
- **作用**：记录已上传的文件信息
- **格式**：JSON格式，包含文件名、分类、上传时间等

## 使用命令

### 1. 上传新图片到云端
```
同步到云端
```

**行为**：
- 只上传从未上传过的图片
- 已上传的图片自动跳过
- 显示上传进度和跳过的文件数量

### 2. 从云端下载图片
```
从云端同步
```

**行为**：
- 只下载本地不存在的图片
- 已存在的图片自动跳过
- 显示下载进度和跳过的文件数量

### 3. 检查同步状态
```
同步状态
```

**显示**：
- 本地文件总数
- 远程文件总数
- 未上传的文件数量
- 需要下载的文件数量

## 示例流程

### 首次使用
1. 配置R2信息
2. 执行 `同步到云端` → 上传所有本地图片
3. 上传记录自动保存

### 添加新表情后
1. 使用 `上传图片` 命令添加新表情到本地
2. 执行 `同步到云端` → 只上传新添加的表情
3. 旧表情自动跳过

### 换设备或重装后
1. 配置R2信息
2. 执行 `从云端同步` → 下载所有云端图片到本地
3. 本地已存在的文件自动跳过

## 注意事项

1. **上传记录与文件绑定**：
   - 记录基于文件名和分类路径
   - 重命名文件会被视为新文件
   - 移动文件分类会被视为新文件

2. **手动重置**：
   - 删除 `.upload_tracker.json` 文件可重置上传记录
   - 下次上传时会重新上传所有文件

3. **R2存储桶**：
   - 上传记录只存在于本地
   - R2存储桶中可以看到所有已上传的文件
   - 删除R2中的文件不会自动更新上传记录

4. **文件冲突**：
   - 如果R2中已存在同名文件，会直接覆盖
   - 建议在R2控制台开启版本控制（可选）

## 故障排查

### 上传记录不生效
- 检查 `memes_data/memes/.upload_tracker.json` 文件是否存在
- 确认文件有写入权限
- 查看日志是否有错误信息

### 文件被重复上传
- 检查文件名是否被修改过
- 确认分类路径是否变化
- 可以尝试删除上传记录文件后重新上传

### 下载时跳过文件异常
- 检查本地文件是否完整
- 确认文件路径是否正确
- 可以手动删除本地文件后重新下载

## 配置示例

```json
{
  "image_host": "cloudflare_r2",
  "image_host_config": {
    "cloudflare_r2": {
      "account_id": "你的账户ID",
      "access_key_id": "你的访问密钥",
      "secret_access_key": "你的秘密密钥",
      "bucket_name": "你的存储桶名称",
      "public_url": "https://你的自定义域名.com"
    }
  }
}
```

配置完成后，使用命令即可体验智能上传和下载功能！